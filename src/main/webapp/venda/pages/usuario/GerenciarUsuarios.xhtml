<ui:composition template="/WEB-INF/template/TemplateLogado.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui">

    <ui:define name="corpo">
        <h:form id="form">
            <div class="card">
                <p:growl id="aviso" widgetVar="growlAviso" autoUpdate="true" closable="true" life="3000"
                         appendTo="@(body)"/>
                <p:messages globalOnly="true" closable="true"/>
                <h1 class="tituloPagina">Gerenciamento de usuários</h1>
                <p:dataTable id="tabelaUsuarios" var="usuarios" paginator="true" paginatorPosition="bottom" rows="10"
                             value="#{gerenciarUsuariosMB.usuarios}">
                    <p:column headerText="Usuário" sortBy="#{usuarios.login}">
                        <h:outputText value="#{usuarios.login}"/>
                    </p:column>
                    <p:column headerText="Nome Completo" sortBy="#{usuarios.nome}">
                        <h:outputText value="#{usuarios.nome}"/>
                    </p:column>
                    <p:column headerText="Ações e pemirssões" sortBy="#{usuarios.admin}">
                        <div style="display: flex; gap: 1rem">
                            <p:commandButton icon="pi pi-lock" value="Resetar Senha"
                                             action="#{gerenciarUsuariosMB.resetarSenha}"
                                             process="@this"
                                             update=":formDialog:conteudoSenha @form">

                                <f:setPropertyActionListener target="#{gerenciarUsuariosMB.usuarioSelecionado}"
                                                             value="#{usuarios}"/>

                                <p:confirm header="Confirmação - Resetar Senha"
                                           icon="pi pi-exclamation-triangle"
                                           message="Deseja resetar a senha do usuário?">
                                </p:confirm>
                            </p:commandButton>

                            <p:commandButton process="@this"
                                             update=":formDialog:dlgEditar"
                                             id="btnEditar"
                                             icon="pi pi-pencil"
                                             oncomplete="PF('dlgEditar').show();">
                                <f:setPropertyActionListener target="#{gerenciarUsuariosMB.usuarioSelecionado}"
                                                             value="#{usuarios}"/>
                            </p:commandButton>
                            <p:tooltip for="btnEditar" value="Editar Usuário" showEffect="clip" hideEffect="fold"
                                       position="top"/>

                            <p:commandButton action="#{gerenciarUsuariosMB.excluirUsuario}"
                                             update="@form"
                                             process="@this"
                                             id="btnExcluir" icon="pi pi-trash"
                                             styleClass="ui-button-danger">
                                <f:setPropertyActionListener target="#{gerenciarUsuariosMB.usuarioSelecionado}"
                                                             value="#{usuarios}"/>
                                <p:confirm header="Confirmação - Exclusão Usuário"
                                           message="Deseja realmente excluir o usuário?"
                                           icon="pi pi-exclamation-triangle"/>
                            </p:commandButton>
                            <p:tooltip for="btnExcluir" value="Excluir Usuário" showEffect="clip" hideEffect="fold"
                                       position="top"/>
                            <p:column headerText="Permissão (admin)">
                                <div style="display: flex; gap: 1rem; ">
                                    <p:commandButton id="btnAdmin"
                                                     action="#{gerenciarUsuariosMB.alterarAdmin}"
                                                     update="@form"
                                                     process="@this"
                                                     icon="#{usuarios.admin ? 'pi pi-star-fill' : 'pi pi-star'}"
                                                     class="ui-button-warning">
                                        <f:setPropertyActionListener target="#{gerenciarUsuariosMB.usuarioSelecionado}"
                                                                     value="#{usuarios}"/>
                                    </p:commandButton>
                                    <p:tooltip for="btnAdmin" value="Altera Permissão" showEffect="clip"
                                               hideEffect="fold"
                                               position="top"/>
                                </div>
                            </p:column>
                        </div>
                    </p:column>
                </p:dataTable>
            </div>
        </h:form>
        <h:form id="formDialog">
            <p:dialog header="Edição de Usuário" widgetVar="dlgEditar" modal="true" resizable="false"
                      id="dlgEditar" style="min-width: 500px">
                <p:outputPanel id="conteudoDialog">
                    <div class="grid ui-fluid"
                         style="display: flex; justify-content: center; margin-top: 2px">
                        <div class="col-12 md:col-4"
                             style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">
                            <div style="display: flex; flex-direction: column;">
                                <p:outputLabel value="Usuário" styleClass="soft-label"/>
                                <div class="ui-inputgroup">
                                    <div class="ui-inputgroup-addon">
                                        <i class="pi pi-user"></i>
                                    </div>
                                    <p:inputText value="#{gerenciarUsuariosMB.usuarioSelecionado.login}"
                                                 maxlength="10" required="true"
                                                 requiredMessage="Login é obrigatório"/>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <p:outputLabel value="Nome Completo" styleClass="soft-label"/>
                                <div class="ui-inputgroup">
                                    <div class="ui-inputgroup-addon">
                                        <i class="pi pi-user-edit"></i>
                                    </div>
                                    <p:inputText value="#{gerenciarUsuariosMB.usuarioSelecionado.nome}"
                                                 maxlength="40" required="true"
                                                 requiredMessage="Nome é obrigatório"/>
                                </div>
                            </div>
                            <div class="dialog-actions">
                                <p:commandButton value="Cancelar"
                                                 type="button"
                                                 onclick="PF('dlgEditar').hide();"
                                                 styleClass="ui-button-secondary"/>

                                <p:commandButton action="#{gerenciarUsuariosMB.salvarAlteracoes}"
                                                 value="Atualizar Usuário!"
                                                 icon="pi pi-check"
                                                 process="@form"
                                                 update=":formDialog:conteudoDialog :form"
                                                 ajax="true"
                                                 oncomplete="if (args.salvo) PF('dlgEditar').hide();"/>
                            </div>
                        </div>
                    </div>
                </p:outputPanel>
            </p:dialog>

            <p:dialog header="Senha gerada - Usuário:"
                      widgetVar="dlgSenhaGerada"
                      modal="true"
                      resizable="false"
                      closable="true">

                <p:outputPanel id="conteudoSenha">
                    <div class="senha-container">
                        <p:commandButton icon="pi pi-copy"
                                         title="Copiar senha"
                                         onclick="copiarSenhaJS()"
                                         styleClass="ui-button-text ui-button-secondary"/>
                        <span id="senhaGerada" class="senha-texto">
                          #{gerenciarUsuariosMB.senhaGerada}
                        </span>
                    </div>
                </p:outputPanel>
            </p:dialog>
            <h:outputScript>
                function copiarSenhaJS() {
                const senhaEl = document.getElementById('senhaGerada');
                if (!senhaEl) return;

                navigator.clipboard.writeText(senhaEl.innerText)
                .then(() => {
                    PF('dlgSenhaGerada').hide();

                setTimeout(() => {
                    PF('growlAviso').renderMessage({
                        summary: 'Sucesso',
                        detail: 'Senha copiada!',
                        severity: 'info'
                    });
                }, 3000);
                });
                }
            </h:outputScript>
        </h:form>
    </ui:define>
</ui:composition>